{
   "$schema":"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
   "contentVersion":"1.0.0.0",
   "parameters":{
      "webAppNamePrefix":{
         "type":"string",
         "metadata":{
            "description":"Prefix used for creating web applications"
         }
      },
      "ADApplicationTenant":{
         "type":"string",
         "metadata":{
            "description":"The value should match the value provided for Active Directory TenantID in the Technical Configuration of the Transactable Offer in Partner Center"
         }
      },
      "ADApplicationID":{
         "type":"string",
         "metadata":{
            "description":"The value should match the value provided for Active Directory Application ID in the Technical Configuration of the Transactable Offer in Partner Center"
         }
      },
      "ADApplicationSecret":{
         "type":"securestring",
         "metadata":{
            "description":"Secret key of the AD Application"
         }
      },
      "ADMTApplicationID":{
         "type":"string",
         "metadata":{
            "description":"The value should match the value provided for Multi Tenant Active Directory Application ID in the Technical Configuration of the Transactable Offer in Partner Center"
         }
      },
      "ADMTApplicationSecret":{
         "type":"string",
         "metadata":{
            "description":"Secret key of the ADMT Application"
         }
      },
      "ADDomain":{
         "type":"string",
         "metadata":{
            "description":"AAD Domain"
         }
      },

      "CaptureContainer":{
         "type":"string",
         "metadata":{
            "description":"URI for Metering Billing Storage Capture Container"
         }
      },
      "CaptureFormat":{
         "type":"string",
          "defaultValue": "{Namespace}/{EventHub}/p{PartitionId}--{Year}-{Month}-{Day}--{Hour}-{Minute}-{Second}",
         "metadata":{
            "description":"Capture Message Format"
         }
      },
      "CheckPointContainer":{
         "type":"string",
         "metadata":{
            "description":"URI for Metering Billing Storage Checkpoint Container"
         }
      },
      "SnapshotsContainer":{
         "type":"string",
         "metadata":{
            "description":"URI for Metering Billing Storage Snapshot Container"
         }
      },
      "EventHubInstance":{
         "type":"string",
         "metadata":{
            "description":"Metering Billing EventHub Instance Name"
         }
      },
      "EventHubNameSpace":{
         "type":"string",
         "metadata":{
            "description":"Metering Billing EventHub Name Space"
         }
      },
      "ADApplicationIDInfra":{
         "type":"string",
         "metadata":{
            "description":"AD Application ID For Metering Billing Infrastructure"
         }
      },
      "ADApplicationSecretInfra":{
         "type":"string",
         "metadata":{
            "description":"AD Application ID Secret For Metering Billing Infrastructure"
         }
      },
      "OcrEndPoint":{
         "type":"string",
         "metadata":{
            "description":"Azure OCR EndPoint"
         }
      },
      "SubscriptionKey":{
         "type":"string",
         "metadata":{
            "description":"Azure OCR Subscription"
         }
      },
      "StorageConnectionString":{
         "type":"string",
         "metadata":{
            "description":"Metering Billing Storage Account Connection String"
         }
      }
   },
   "variables":{
      "alwaysOn":true,
      "skuCode":"B1",
      "location":"[resourceGroup().location]",
      "appServicePlanName":"[concat(parameters('webAppNamePrefix'),'SvcPlan')]",
      "ProvisioningServiceAppName":"[concat(parameters('webAppNamePrefix'),'-landing')]",
      "PublisherServiceAppName":"[concat(parameters('webAppNamePrefix'),'-Publisher')]",
      "SaaSServiceAppName":"[concat(parameters('webAppNamePrefix'),'-Metered')]"
   },
   "resources":[
      {
         "type":"Microsoft.Web/serverfarms",
         "apiVersion":"2019-08-01",
         "name":"[variables('appServicePlanName')]",
         "location":"[variables('location')]",
         "sku":{
            "name":"[variables('skuCode')]",
            "capacity":"1"
         },
         "tags":{
            "displayName":"[variables('appServicePlanName')]"
         },
         "properties":{
            "name":"[variables('appServicePlanName')]"
         },
         "kind":"linux"
      },
      {
         "name":"[variables('ProvisioningServiceAppName')]",
         "type":"Microsoft.Web/sites",
         "apiVersion":"2019-08-01",
         "location":"[variables('location')]",
         "tags":{
            "displayName":"[variables('ProvisioningServiceAppName')]"
         },
         "dependsOn":[
            "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]"
         ],
         "properties":{
            "name":"[variables('ProvisioningServiceAppName')]",
            "serverFarmId":"[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
            "siteConfig":{
               "appSettings":[
                  {
                     "name":"AzureAd__CallbackPath",
                     "value":"/signin-oidc",
                     "slotSetting":false
                  },
                  {
                     "name":"AzureAd__ClientId",
                     "value":"[parameters('ADMTApplicationID')]",
                     "slotSetting":false
                  },
                  {
                     "name":"AzureAd__ClientSecret",
                     "value":"[parameters('ADMTApplicationSecret')]",
                     "slotSetting":false
                  },
                  {
                     "name":"AzureAd__Domain",
                     "value":"[parameters('ADDomain')]",
                     "slotSetting":false
                  },
                  {
                     "name":"AzureAd__Instance",
                     "value":"https://login.microsoftonline.com/",
                     "slotSetting":false
                  },
                  {
                     "name":"AzureAd__SignedOutCallbackPath",
                     "value":"/signout-callback-oidc",
                     "slotSetting":false
                  },
                  {
                     "name":"AzureAd__TenantId",
                     "value":"[parameters('ADApplicationTenant')]",
                     "slotSetting":false
                  },
                  {
                     "name":"DownloadLocation",
                     "value":"D:\\home\\site\\wwwroot\\",
                     "slotSetting":false
                  },
                  {
                     "name":"MarketplaceApi__ClientId",
                     "value":"[parameters('ADApplicationID')]",
                     "slotSetting":false
                  },
                  {
                     "name":"MarketplaceApi__ClientSecret",
                     "value":"[parameters('ADApplicationSecret')]",
                     "slotSetting":false
                  },
                  {
                     "name":"MarketplaceApi__TenantId",
                     "value":"[parameters('ADApplicationTenant')]",
                     "slotSetting":false
                  },
                  {
                     "name":"WEBSITE_NODE_DEFAULT_VERSION",
                     "value":"6.9.1",
                     "slotSetting":false
                  }
               ],
               "metadata":[
                  {
                     "name":"CURRENT_STACK",
                     "value":"dotnetcore"
                  }
               ],
               "alwaysOn":"[variables('alwaysOn')]"
            }
         }
      },
      {
         "name":"[variables('PublisherServiceAppName')]",
         "type":"Microsoft.Web/sites",
         "apiVersion":"2019-08-01",
         "location":"[variables('location')]",
         "tags":{
            "displayName":"[variables('PublisherServiceAppName')]"
         },
         "dependsOn":[
            "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]"
         ],
         "properties":{
            "name":"[variables('PublisherServiceAppName')]",
            "serverFarmId":"[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
            "siteConfig":{
               "appSettings":[
                  {
                     "name":"AzureAd__CallbackPath",
                     "value":"/signin-oidc",
                     "slotSetting":false
                  },
                  {
                     "name":"AzureAd__ClientId",
                     "value":"[parameters('ADMTApplicationID')]",
                     "slotSetting":false
                  },
                  {
                     "name":"AzureAd__ClientSecret",
                     "value":"[parameters('ADMTApplicationSecret')]",
                     "slotSetting":false
                  },
                  {
                     "name":"AzureAd__Domain",
                     "value":"[parameters('ADDomain')]",
                     "slotSetting":false
                  },
                  {
                     "name":"AzureAd__Instance",
                     "value":"https://login.microsoftonline.com/",
                     "slotSetting":false
                  },
                  {
                     "name":"AzureAd__SignedOutCallbackPath",
                     "value":"/signout-callback-oidc",
                     "slotSetting":false
                  },
                  {
                     "name":"AzureAd__TenantId",
                     "value":"[parameters('ADApplicationTenant')]",
                     "slotSetting":false
                  },
                  {
                     "name":"DownloadLocation",
                     "value":"D:\\home\\site\\wwwroot\\",
                     "slotSetting":false
                  },
                  {
                     "name":"MarketplaceApi__ClientId",
                     "value":"[parameters('ADApplicationID')]",
                     "slotSetting":false
                  },
                  {
                     "name":"MarketplaceApi__ClientSecret",
                     "value":"[parameters('ADApplicationSecret')]",
                     "slotSetting":false
                  },
                  {
                     "name":"MarketplaceApi__TenantId",
                     "value":"[parameters('ADApplicationTenant')]",
                     "slotSetting":false
                  },
                  {
                     "name":"WEBSITE_NODE_DEFAULT_VERSION",
                     "value":"6.9.1",
                     "slotSetting":false
                  },
                  {
                     "name":"StorageConnectionString",
                     "value":"[parameters('StorageConnectionString')]",
                     "slotSetting":false
                  },
                  {
                     "name":"AZURE_METERING_INFRA_CAPTURE_CONTAINER",
                     "value":"[parameters('CaptureContainer')]",
                     "slotSetting":false
                  },
                  {
                     "name":"AZURE_METERING_INFRA_CAPTURE_FILENAME_FORMAT",
                     "value":"[parameters('CaptureFormat')]",
                     "slotSetting":false
                  },
                  {
                     "name":"AZURE_METERING_INFRA_CHECKPOINTS_CONTAINER",
                     "value":"[parameters('CheckPointContainer')]",
                     "slotSetting":false
                  },
                  {
                     "name":"AZURE_METERING_INFRA_CLIENT_ID",
                     "value":"[parameters('ADApplicationIDInfra')]",
                     "slotSetting":false
                  },
                  {
                     "name":"AZURE_METERING_INFRA_CLIENT_SECRET",
                     "value":"[parameters('ADApplicationSecretInfra')]",
                     "slotSetting":false
                  },
                  {
                     "name":"AZURE_METERING_INFRA_EVENTHUB_INSTANCENAME",
                     "value":"[parameters('EventHubInstance')]",
                     "slotSetting":false
                  },
                  {
                     "name":"AZURE_METERING_INFRA_EVENTHUB_NAMESPACENAME",
                     "value": "[parameters('EventHubNameSpace')]",
                      "slotSetting": false
                    },
                    {
                       "name": "AZURE_METERING_INFRA_SNAPSHOTS_CONTAINER",
                       "value": "[parameters('SnapshotsContainer')]",
                     "slotSetting":false
                  },
                  {
                     "name":"AZURE_METERING_INFRA_TENANT_ID",
                     "value":"[parameters('ADApplicationTenant')]",
                     "slotSetting":false
                  }
               ],
               "metadata":[
                  {
                     "name":"CURRENT_STACK",
                     "value":"dotnetcore"
                  }
               ],
               "alwaysOn":"[variables('alwaysOn')]"
            }
         }
      },
      {
         "name":"[variables('SaaSServiceAppName')]",
         "type":"Microsoft.Web/sites",
         "apiVersion":"2019-08-01",
         "location":"[variables('location')]",
         "tags":{
            "displayName":"[variables('SaaSServiceAppName')]"
         },
         "dependsOn":[
            "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]"
         ],
         "properties":{
            "name":"[variables('SaaSServiceAppName')]",
            "serverFarmId":"[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
            "siteConfig":{
               "appSettings":[
                  {
                     "name":"AzureAd__CallbackPath",
                     "value":"/signin-oidc",
                     "slotSetting":false
                  },
                  {
                     "name":"AzureAd__ClientId",
                     "value":"[parameters('ADMTApplicationID')]",
                     "slotSetting":false
                  },
                  {
                     "name":"AzureAd__ClientSecret",
                     "value":"[parameters('ADMTApplicationSecret')]",
                     "slotSetting":false
                  },
                  {
                     "name":"AzureAd__Domain",
                     "value":"[parameters('ADDomain')]",
                     "slotSetting":false
                  },
                  {
                     "name":"AzureAd__Instance",
                     "value":"https://login.microsoftonline.com/",
                     "slotSetting":false
                  },
                  {
                     "name":"AzureAd__SignedOutCallbackPath",
                     "value":"/signout-callback-oidc",
                     "slotSetting":false
                  },
                  {
                     "name":"AzureAd__TenantId",
                     "value":"[parameters('ADApplicationTenant')]",
                     "slotSetting":false
                  },
                  {
                     "name":"DownloadLocation",
                     "value":"D:\\home\\site\\wwwroot\\",
                     "slotSetting":false
                  },
                  {
                     "name":"ocrEndPoint",
                     "value":"[parameters('OcrEndPoint')]",
                     "slotSetting":false
                  },
                  {
                     "name":"SaaSDimension",
                     "value":"",
                     "slotSetting":false
                  },
                  {
                     "name":"SaasSubscription",
                     "value":"",
                     "slotSetting":false
                  },
                  {
                     "name":"StorageConnectionString",
                     "value":"[parameters('StorageConnectionString')]",
                     "slotSetting":false
                  },
                  {
                     "name":"subscriptionKey",
                     "value":"[parameters('SubscriptionKey')]",
                     "slotSetting":false
                  },
                  {
                     "name":"WEBSITE_NODE_DEFAULT_VERSION",
                     "value":"6.9.1",
                     "slotSetting":false
                  },
                  {
                     "name":"AZURE_METERING_INFRA_CAPTURE_CONTAINER",
                     "value":"[parameters('CaptureContainer')]",
                     "slotSetting":false
                  },
                  {
                     "name":"AZURE_METERING_INFRA_CAPTURE_FILENAME_FORMAT",
                     "value":"[parameters('CaptureFormat')]",
                     "slotSetting":false
                  },
                  {
                     "name":"AZURE_METERING_INFRA_CHECKPOINTS_CONTAINER",
                     "value":"[parameters('CheckPointContainer')]",
                     "slotSetting":false
                  },
                  {
                     "name":"AZURE_METERING_INFRA_CLIENT_ID",
                     "value":"[parameters('ADApplicationIDInfra')]",
                     "slotSetting":false
                  },
                  {
                     "name":"AZURE_METERING_INFRA_CLIENT_SECRET",
                     "value":"[parameters('ADApplicationSecretInfra')]",
                     "slotSetting":false
                  },
                  {
                     "name":"AZURE_METERING_INFRA_EVENTHUB_INSTANCENAME",
                     "value":"[parameters('EventHubInstance')]",
                     "slotSetting":false
                  },
                  {
                     "name":"AZURE_METERING_INFRA_EVENTHUB_NAMESPACENAME",
                     "value":"[parameters('EventHubNameSpace')]",
                     "slotSetting":false
                  },
                  {
                     "name":"AZURE_METERING_INFRA_SNAPSHOTS_CONTAINER",
                     "value":"[parameters('SnapshotsContainer')]",
                     "slotSetting":false
                  },
                  {
                     "name":"AZURE_METERING_INFRA_TENANT_ID",
                     "value":"[parameters('ADApplicationTenant')]",
                     "slotSetting":false
                  }
               ],
               "metadata":[
                  {
                     "name":"CURRENT_STACK",
                     "value":"dotnetcore"
                  }
               ],
               "alwaysOn":"[variables('alwaysOn')]"
            }
         }
      }
   ],
   "outputs":{
      "CustomerPortal":{
         "type":"string",
         "value":"[reference(concat('Microsoft.Web/sites/', variables('ProvisioningServiceAppName'))).hostnames[0]]"
      },
      "PublisherPortal":{
         "type":"string",
         "value":"[reference(concat('Microsoft.Web/sites/', variables('PublisherServiceAppName'))).hostnames[0]]"
      },
      "SaaSPortal":{
         "type":"string",
         "value":"[reference(concat('Microsoft.Web/sites/', variables('SaaSServiceAppName'))).hostnames[0]]"
      }
   }
}